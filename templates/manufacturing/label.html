{% extends 'base.html' %}
{% load static %}
{% block title %}生产过程{% endblock %}
{% block css %}

    <link href="{% static 'css/bootstrap-editable.css' %}" rel="stylesheet"/>
    <link href="{% static 'bootstrap-table-1.18.0/dist/bootstrap-table.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/toastr.min.css' %}" rel="stylesheet">

{% endblock %}

{% block breadcrumb %}
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>生产过程<small>Manufacturing</small></h1>
        <ol class="breadcrumb">
            <li><a href="#">主页</a></li>
            <li class="active">生产过程</li>
        </ol>
    </section>
{% endblock %}

{% block content %}
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">{{ step.name }}</h3>
                    </div>

                    <!-- /.box-header -->
                    <div class="box-body" >
                        {#        自定义搜索条件区域#}
                        <div class="col-xs-12">
                            <div class="form-inline col-xs-12" style="margin: 5px;margin-bottom: 20px;">
                                <input id="Input1" class="form-control" style="width: 100%;
                                                                                        min-width: 200px;
                                                                                        max-width: 500px;
                                                                                        height: 100%;
                                                                                        min-height: 40px;
                                                                                        font-size: 20px;
                                                                                        margin: 5px;"
                                       placeholder="请输入车辆VIN...">
                                <button id="print" style="margin-left: 5px;" type="button" class="btn btn-lg btn-default" onclick="printBtn()">打印</button>
                            </div>
                            <div class="col-xs-4">
                                <div class="form-inline form-group">
                                    <label class="control-label" >当前VIN:</label>
                                    <label id="product_vin" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >产品物料号:</label>
                                    <label id="product_erp" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >产品名称:</label>
                                    <label id="product_name" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >产品型号:</label>
                                    <label id="product_model" class="control-label" ></label>
                                </div>

                            </div>
                            <div class="col-xs-4">
                                <div class="form-inline form-group">
                                    <label class="control-label" >订单号:</label>
                                    <label id="order_num" class="control-label" ></label>
                                </div>
                               <div class="form-inline form-group">
                                    <label class="control-label" >订单数量:</label>
                                    <label id="order_quantity" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >本工序完成数量:</label>
                                    <label id="finish_quantity" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >本工序完成率:</label>
                                    <label id="finish_rate" class="control-label" ></label>
                                </div>

                            </div>
                            <div class="col-xs-4">
                                <div class="form-inline form-group">
                                    <label class="control-label" >当前状态:</label>
                                    <label id="status" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >操作员:</label>
                                    <label id="user" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >操作日期:</label>
                                    <label id="date" class="control-label" ></label>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block script %}

    <script src="{% static 'bootstrap-table-1.18.0/dist/bootstrap-table.js' %}"></script>
    <script src="{% static 'bootstrap-table-1.18.0/dist/locale/bootstrap-table-zh-CN.js' %}"></script>
    <script src="{% static 'js/bootstrap-editable.min.js' %}"></script>
    <script src="{% static 'bootstrap-table-1.18.0/dist/extensions/editable/bootstrap-table-editable.js' %}"></script>

    <script src="{% static 'js/toastr.min.js' %}"></script>
    <script src="{% static 'js/jquery.cookie.js' %}"></script>
    <script src="{% static 'js/myscript.js' %}"></script>

<script>

    toastr.options = {
            closeButton: true,
            debug: true,
            progressBar: true,
            positionClass: "toast-top-center",
            onclick: null,
            showDuration: "300",
            hideDuration: "1000",
            timeOut: "2000",
            extendedTimeOut: "1000",
            showEasing: "swing",
            hideEasing: "linear",
            showMethod: "fadeIn",
            hideMethod: "fadeOut",
        };

    let obj = {};
    {% for category in material_categorys %}
        obj["{{category.0}}"]= "{{ category.1 }}";
    {% endfor %}

    function printBtn() {
        var formdata = new FormData(); //ajax上传文件的时候，需要这个类型，它会将添加给它的键值对加工成formdata的类型
        formdata.append('snInput', $('#Input1').val());
        $.ajax(
            {
                //几个参数需要注意一下
                cache:false,
                type: "POST",//方法类型
                dataType: "json",//预期服务器返回的数据类型
                url: "{% url 'manufacturing:getOrderInfo' step.id %}" , //url
                headers:{"X-CSRFToken":$.cookie("csrftoken")},
                data: formdata, //将模态框的form表单数据序列化，以便提交到后台
                processData: false,// 不加会报错
                contentType: false,// 不加会报错
                async:true,  //必须要为false,必须必须

                success: function (data) {
                    if(data.ret){
                        $('#product_vin').text(data.info.product_vin);
                        $('#product_erp').text(data.info.product_erp);
                        $('#product_name').text(data.info.product_name);
                        $('#product_model').text(data.info.product_model);
                        $('#order_num').text(data.info.order_num);
                        $('#order_quantity').text(data.info.order_quantity);
                        $('#finish_quantity').text(data.info.finish_quantity);
                        $('#finish_rate').text(data.info.finish_rate);
                        $('#status').text(data.info.status);
                        $('#user').text(data.info.user);
                        $('#date').text(data.info.date);
                        $('#Input1').val('');

                        $('#Input1').focus();
                        print(data.info.product_vin, data.info.filename);

                     }
                    else {
                        toastr.error('Error: ' + data.errMsg)
                    }
                 },
                error : function() {
                    toastr.error("输入数据有误！");
                 }
            });
    }

    function print(vin, filename){
         var array = new Array();
        var obj = { BatteryCapacity:"5555",
		            CarsClassificationName: '1111',
                    CreateTime: '2020-10-10T15:23:33.1',
                    MaxDeadweight:"7777",
                    MaxDesignDeadweight:"8888",
                    Power: "4444",
                    ProductCode:"3333",
                    TruckLoadingList: '2222',
                    Voltage:"6666",
                    printType: filename,
                    vin: vin};
        array.push(obj);
        $.post("http://127.0.0.1:6677",{data:array},
        function (data) {
            if(data.success){
                alert("打印成功！");
            }
            else {
                alert("data.message");
            }
        }, "json");
    }


    $('#Input1').keydown(function(e){
        if(e.keyCode==13){
           printBtn();
            }
        });

    $('#Input1').focus();



</script>

{% endblock %}
