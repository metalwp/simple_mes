{% extends 'base.html' %}
{% load static %}
{% block title %}追溯物料检验{% endblock %}
{% block css %}

    <link href="{% static 'css/bootstrap-editable.css' %}" rel="stylesheet"/>
    <link href="{% static 'bootstrap-table-1.18.0/dist/bootstrap-table.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/toastr.min.css' %}" rel="stylesheet">


{% endblock %}

{% block breadcrumb %}
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>追溯物料检验<small>TraceMaterialInspection</small></h1>
        <ol class="breadcrumb">
            <li><a href="#">主页</a></li>
            <li class="active">追溯物料检验</li>
        </ol>
    </section>
{% endblock %}

{% block content %}
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">追溯物料检验</h3>
                    </div>

                    <!-- /.box-header -->
                    <div class="box-body" >
                        {#        自定义搜索条件区域#}
                        <div class="col-xs-12">
                            <div class="form-inline col-xs-12" style="margin: 5px;margin-bottom: 20px;">
                                <input id="Input1" class="form-control" style="width: 100%;
                                                                                        min-width: 400px;
                                                                                        max-width: 600px;
                                                                                        height: 100%;
                                                                                        min-height: 40px;
                                                                                        font-size: 20px;
                                                                                        margin: 5px;"
                                       placeholder="请输入SN..." autofocus>
                                <input id="Input2" class="form-control" style="width: 100%;
                                                                                        min-width: 100px;
                                                                                        max-width: 200px;
                                                                                        height: 100%;
                                                                                        min-height: 40px;
                                                                                        font-size: 20px;
                                                                                        margin: 5px;"
                                       placeholder="请输入批次号">
                                <button id="search" style="margin-left: 5px;" type="button" class="btn btn-lg btn-default" onclick="search()">查询</button>
                                <button id="save" style="margin-left: 5px;" type="button" class="btn btn-lg btn-primary" onclick="save()">保存检验结果</button>
                            </div>
                            <div class="col-xs-4">
                                <div class="form-inline form-group">
                                    <label class="control-label" >SN:</label>
                                    <label id="sn" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >物料号:</label>
                                    <label id="erp_no" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >物料名称:</label>
                                    <label id="name" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >物料分类:</label>
                                    <label id="category" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >型号描述:</label>
                                    <label id="model" class="control-label" ></label>
                                </div>
                            </div>
                            <div class="col-xs-4">
                                <div class="form-inline form-group">
                                    <label class="control-label" >批次号:</label>
                                    <label id="batch_num" class="control-label" ></label>
                                </div>
                               <div class="form-inline form-group">
                                    <label class="control-label" >批次数量:</label>
                                    <label id="batch_quantity" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >合格数量:</label>
                                    <label id="qualified_quantity" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >合格率:</label>
                                    <label id="pass_rate" class="control-label" ></label>
                                </div>

                            </div>
                            <div class="col-xs-4">
                                <div class="form-inline form-group">
                                    <label class="control-label" >当前状态:</label>
                                    <label id="status" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >检验员:</label>
                                    <label id="user" class="control-label" ></label>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="control-label" >检验日期:</label>
                                    <label id="date" class="control-label" ></label>
                                </div>
                            </div>
                        </div>


                        {#        bootstrap table自动渲染区域#}
                        <div class="col-xs-12">
                            {% csrf_token %}
                            <table id="myTab" class="table table-bordered table-hover" style="table-layout:fixed;word-break:break-all;"></table>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block script %}

    <script src="{% static 'bootstrap-table-1.18.0/dist/bootstrap-table.js' %}"></script>
    <script src="{% static 'bootstrap-table-1.18.0/dist/locale/bootstrap-table-zh-CN.js' %}"></script>
    <script src="{% static 'js/bootstrap-editable.min.js' %}"></script>
    <script src="{% static 'bootstrap-table-1.18.0/dist/extensions/editable/bootstrap-table-editable.js' %}"></script>

    <script src="{% static 'js/toastr.min.js' %}"></script>
    <script src="{% static 'js/jquery.cookie.js' %}"></script>
    <script src="{% static 'js/myscript.js' %}"></script>

<script>

    toastr.options = {
            closeButton: true,
            debug: true,
            progressBar: true,
            positionClass: "toast-top-center",
            onclick: null,
            showDuration: "300",
            hideDuration: "1000",
            timeOut: "2000",
            extendedTimeOut: "1000",
            showEasing: "swing",
            hideEasing: "linear",
            showMethod: "fadeIn",
            hideMethod: "fadeOut",
        };

    let obj = {};
    {% for category in material_categorys %}
        obj["{{category.0}}"]= "{{ category.1 }}";
    {% endfor %}

    function search() {
        var formdata = new FormData(); //ajax上传文件的时候，需要这个类型，它会将添加给它的键值对加工成formdata的类型
        var token = $("[name='csrfmiddlewaretoken']").val();
        {#formdata.append("csrfmiddlewaretoken", token); //别忘了csrf_token#}
        formdata.append("snInput", $("#Input1").val());
        formdata.append('batchInput', $("#Input2").val());
        $.ajax(
            {
                //几个参数需要注意一下
                cache:false,
                type: "POST",//方法类型
                dataType: "json",//预期服务器返回的数据类型
                url: "{% url 'Inspection:getTMaterialInfo' %}" , //url
                headers:{"X-CSRFToken":$.cookie("csrftoken")},
                data: formdata, //将模态框的form表单数据序列化，以便提交到后台
                processData: false,// 不加会报错
                contentType: false,// 不加会报错
                async:true,  //必须要为false,必须必须

                success: function (data) {
                    if(data.ret){
                        $('#sn').text(data.info.sn);
                        $('#status').text(data.info.status);

                        $('#erp_no').text(data.info.erp_no);
                        $('#name').text(data.info.name);
                        $('#category').text(obj[data.info.category]);
                        $('#model').text(data.info.model);
                        $('#batch_num').text(data.info.batch_num);
                        $('#qualified_quantity').text(data.info.qualified_quantity);
                        $('#batch_quantity').text(data.info.batch_quantity);
                        $('#pass_rate').text(data.info.pass_rate);
                        $('#user').text(data.info.user);
                        $('#date').text(data.info.date);

                        $("#myTab").bootstrapTable('refresh');
                        $('#Input1').val('');
                        $('#Input2').val('');
                        $('#Input1').focus();

                     }
                    else {
                        toastr.error('Error: ' + data.errMsg)
                    }
                 },
                error : function() {
                    toastr.error("输入数据有误！");
                 }
            });
    }

    function save() {
        var allTableData = $("#myTab").bootstrapTable("getData");
        data = {};
        data.snInput = $("#sn").text();
        data.batchInput = $("#batch_num").text();
        $('#Input1').val($("#sn").text());
        $('#Input2').val($("#batch_num").text());
        data.row = allTableData;
        var json_data = JSON.stringify(data);
        $.ajax({
            url:"{% url 'Inspection:saveTMInspectionData' %}",
            headers:{"X-CSRFToken":$.cookie("csrftoken")},
            type:"post",
            data:json_data, //将添加好数据的formdata放到data这里
            processData: false,    // 不处理数据
            contentType: false,    // 不设置内容类型
            dataType: "json",
            success:function(data){
                if (data.ret){
                    search();
                    toastr.success("数据保存成功！");

                    }
                else {
                    toastr.error("错误：" + data.errMsg);
                }
                $('#Input1').focus();
                },
            error: function(data){
                toastr.error('导入异常！')
                }
        })
    }

    var columns =  [
            {
                field: 'num',
                title:'检验项编号',
                width: '100',
                align: 'center',
                valign: 'middle',
                sortable: false,
            },
            {
                field: 'name',
                title:'检验项名称',
                width: '200',
                align: 'center',
                valign: 'middle',
                sortable: false,
            },
            {
                field: 'category',
                title:'检验类型',
                width: '150',
                align: 'center',
                valign: 'middle',
                sortable: false,
                formatter: function (value, row, index) {
                    var obj = {};
                    {% for category in inspection_categorys %}
                        obj["{{category.0}}"]= "{{ category.1 }}";
                    {% endfor %}
                    return obj[value];
                }
            },
            {
                field: 'mode',
                title:'检验方法',
                width: '100',
                align: 'center',
                valign: 'middle',
                sortable: false,
                formatter: function (value, row, index) {
                    var obj = {};
                    {% for mode in inspection_modes %}
                        obj["{{mode.0}}"]= "{{ mode.1 }}";
                    {% endfor %}
                    return obj[value];
                }
            },
            {
                field: 'upper',
                title:'上限',
                width: '100',
                align: 'center',
                valign: 'middle',
            },
           {   field: 'lower',
                title:'下限',
                width: '100',
                align: 'center',
                valign: 'middle',
            },
            {   field: 'measure',
                title:'测量值',
                width: '150',
                align: 'center',
                valign: 'middle',
                editable: {
                    type: 'text',
                    emptytext: '空',
                    mode:'inline',
                    validate: function (v) {
                    if (!v) {
                        return "不能为空";
                    }
                },
                },
            },
            {
            field: 'result',
            title: '检验结果',
            width: '150',
            align: 'center',
            valign: 'middle',
            editable: {
                type: 'select',
                emptytext: '空',
                mode:'inline',
                source:[{value:"0",text:"Fail"},{value:"1", text:"Pass"}]
            },
            cellStyle: function (value, row, index) {
                        if (value == "0") {
                            return { css: { "background-color": "red"} }
                        }
                        if (value == undefined || value == "" || isNaN(value)) {
                            return {css: {"background-color": "yellow"}}
                        }
                        if(value == "1") {
                            return { css: { "background-color": "green"} }
                        }
                    },
            }
        ];
    var urls = "{% url 'Inspection:getTMInspectionData' %}";
    tableFresh2(columns, urls, 'id');
    $('#Input1').focus();


</script>

{% endblock %}
